name: Testing and building releases

on: [push, pull_request]

permissions:
  contents: read

jobs:
  build-and-test-ubuntu:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt update
      - run: sudo apt install -y vulkan-validationlayers
      - run: sudo apt install -y mesa-vulkan-drivers
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
      - name: Setup gradle
        uses: gradle/actions/setup-gradle@v4
      - run: ./gradlew test
      - run: ./gradlew proguard
      - run: jlink --module-path "%JAVA_HOME%/jmods" --add-modules java.base,jdk.unsupported --output ./game/build/libs/jre
      - run: cp ./build-helper/mohammed ./game/build/libs/jre/mohammed
      - run: cp ./game/build/libs/mohammed.jar ./game/build/libs/jre/mohammed.jar
      - run: ./game/build/libs/jre/mohammed self-test1
      - uses: actions/upload-artifact@v4
        with:
          name: mohammed-linux
          path: ./game/build/libs/jre/

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
      - name: Setup gradle
        uses: gradle/actions/setup-gradle@v4
      - run: ./gradlew proguard
      - run: jlink --module-path "%JAVA_HOME%/jmods" --add-modules java.base,jdk.unsupported --output ./game/build/libs/jre
      # Handle platform-specific dependencies (using .bat or .exe for Windows)
      - run: cp ./build-helper/mohammed.bat ./game/build/libs/jre/mohammed.bat
      - run: cp ./game/build/libs/mohammed.jar ./game/build/libs/jre/mohammed.jar
      - run: ./game/build/libs/jre/mohammed.bat self-test1
      - uses: actions/upload-artifact@v4
        with:
          name: mohammed-windows
          path: ./game/build/libs/jre/

  build-mac:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
      - name: Setup gradle
        uses: gradle/actions/setup-gradle@v4
      - run: ./gradlew proguard
      - run: jlink --module-path "%JAVA_HOME%/jmods" --add-modules java.base,jdk.unsupported --output ./game/build/libs/jre
      - run: cp ./build-helper/mohammed-mac ./game/build/libs/jre/mohammed
      - run: cp ./game/build/libs/mohammed.jar ./game/build/libs/jre/mohammed.jar
      - run: ./game/build/libs/jre/mohammed self-test1
      - uses: actions/upload-artifact@v4
        with:
          name: mohammed-mac
          path: ./game/build/libs/jre/

  self-test-ubuntu:
    runs-on: ubuntu-latest
    needs: build-and-test-ubuntu
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: mohammed-linux
          path: ./game
      - run: chmod 777 ./game/mohammed
      - run: chmod 777 ./game/bin/java
      - run: ./game/mohammed self-test1

  self-test-windows:
    runs-on: windows-latest
    needs: build-windows
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: mohammed-windows
          path: ./game
      - run: ./game/mohammed.bat self-test1

  self-test-mac:
    runs-on: macos-latest
    needs: build-mac
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: mohammed-mac
          path: ./game
      - run: chmod 777 ./game/mohammed
      - run: chmod 777 ./game/bin/java
      - run: ./game/mohammed self-test1
